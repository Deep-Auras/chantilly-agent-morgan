extends ../layouts/dashboard

block content
  //- Page Header
  .mb-8
    .flex.flex-col.md:flex-row.md:items-center.md:justify-between.gap-4
      div
        h1.text-3xl.font-bold.text-gray-900 Agent Configuration
        p.text-gray-600.mt-2 Manage agent personality, feature flags, and system settings

  //- Configuration Sections (Alpine.js reactive)
  div(x-data="configManager()")
    //- Feature Flags Section
    .bg-white.rounded-lg.shadow.p-6.mb-6
      h2.text-xl.font-semibold.text-gray-900.mb-4 Feature Flags
      .space-y-4
        //- Vector Search
        .flex.items-center.justify-between.p-4.border.border-gray-200.rounded-lg
          div
            p.font-medium.text-gray-900 Vector Search
            p.text-sm.text-gray-600 Enable semantic search with vector embeddings
          label.relative.inline-flex.items-center.cursor-pointer
            input.sr-only.peer(
              type="checkbox"
              x-model="featureFlags.ENABLE_VECTOR_SEARCH"
              @change="saveFeatureFlag('ENABLE_VECTOR_SEARCH', $event.target.checked)"
            )
            .w-11.h-6.bg-gray-200.rounded-full.peer(class="peer-checked:bg-blue-600 peer-focus:ring-2 peer-focus:ring-blue-300")
              .absolute.w-5.h-5.bg-white.rounded-full.transition-all(class="left-0.5 top-0.5 peer-checked:translate-x-5")

        //- Semantic Templates
        .flex.items-center.justify-between.p-4.border.border-gray-200.rounded-lg
          div
            p.font-medium.text-gray-900 Semantic Templates
            p.text-sm.text-gray-600 Use vector search for task template matching
          label.relative.inline-flex.items-center.cursor-pointer
            input.sr-only.peer(
              type="checkbox"
              x-model="featureFlags.ENABLE_SEMANTIC_TEMPLATES"
              @change="saveFeatureFlag('ENABLE_SEMANTIC_TEMPLATES', $event.target.checked)"
            )
            .w-11.h-6.bg-gray-200.rounded-full.peer(class="peer-checked:bg-blue-600 peer-focus:ring-2 peer-focus:ring-blue-300")
              .absolute.w-5.h-5.bg-white.rounded-full.transition-all(class="left-0.5 top-0.5 peer-checked:translate-x-5")

        //- Semantic Tools
        .flex.items-center.justify-between.p-4.border.border-gray-200.rounded-lg
          div
            p.font-medium.text-gray-900 Semantic Tool Detection
            p.text-sm.text-gray-600 Use vector search for tool trigger detection
          label.relative.inline-flex.items-center.cursor-pointer
            input.sr-only.peer(
              type="checkbox"
              x-model="featureFlags.ENABLE_SEMANTIC_TOOLS"
              @change="saveFeatureFlag('ENABLE_SEMANTIC_TOOLS', $event.target.checked)"
            )
            .w-11.h-6.bg-gray-200.rounded-full.peer(class="peer-checked:bg-blue-600 peer-focus:ring-2 peer-focus:ring-blue-300")
              .absolute.w-5.h-5.bg-white.rounded-full.transition-all(class="left-0.5 top-0.5 peer-checked:translate-x-5")

    //- Agent Personality Section
    .bg-white.rounded-lg.shadow.p-6.mb-6
      h2.text-xl.font-semibold.text-gray-900.mb-4 Agent Personality
      form(@submit.prevent="savePersonality")
        .grid.grid-cols-1.md:grid-cols-2.gap-6
          //- Communication Style
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2 Communication Style
            select.w-full.px-3.py-2.border.border-gray-300.rounded-lg(
              x-model="personality.communication"
              class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            )
              option(value="professional") Professional
              option(value="friendly") Friendly
              option(value="casual") Casual
              option(value="formal") Formal

          //- Response Length
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2 Response Length
            select.w-full.px-3.py-2.border.border-gray-300.rounded-lg(
              x-model="personality.responseLength"
              class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            )
              option(value="concise") Concise
              option(value="balanced") Balanced
              option(value="detailed") Detailed

          //- Proactiveness
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2 Proactiveness
            select.w-full.px-3.py-2.border.border-gray-300.rounded-lg(
              x-model="personality.proactiveness"
              class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            )
              option(value="reactive") Reactive (wait for requests)
              option(value="suggestive") Suggestive (offer help)
              option(value="proactive") Proactive (anticipate needs)

          //- Humor Level
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2 Humor Level
            input.w-full(
              type="range"
              min="0"
              max="10"
              x-model="personality.humor"
            )
            p.text-sm.text-gray-600.mt-1 Level: <span x-text="personality.humor"></span>/10

        .mt-6.flex.justify-end
          button.px-6.py-2.bg-blue-600.text-white.rounded-lg.transition-colors(
            type="submit"
            class="hover:bg-blue-700"
          ) Save Personality

    //- Rate Limits Section
    .bg-white.rounded-lg.shadow.p-6
      h2.text-xl.font-semibold.text-gray-900.mb-4 Rate Limits
      form(@submit.prevent="saveRateLimits")
        .grid.grid-cols-1.md:grid-cols-2.gap-6
          //- General Rate Limit
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2 General Requests
            input.w-full.px-3.py-2.border.border-gray-300.rounded-lg(
              type="number"
              x-model="rateLimits.general"
              placeholder="100"
              class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            )
            p.text-xs.text-gray-500.mt-1 Requests per minute

          //- Authentication Rate Limit
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2 Authentication
            input.w-full.px-3.py-2.border.border-gray-300.rounded-lg(
              type="number"
              x-model="rateLimits.auth"
              placeholder="10"
              class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            )
            p.text-xs.text-gray-500.mt-1 Login attempts per hour

          //- Webhook Rate Limit
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2 Webhooks
            input.w-full.px-3.py-2.border.border-gray-300.rounded-lg(
              type="number"
              x-model="rateLimits.webhook"
              placeholder="100"
              class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            )
            p.text-xs.text-gray-500.mt-1 Webhook calls per minute

          //- API Rate Limit
          div
            label.block.text-sm.font-medium.text-gray-700.mb-2 API Calls
            input.w-full.px-3.py-2.border.border-gray-300.rounded-lg(
              type="number"
              x-model="rateLimits.api"
              placeholder="60"
              class="focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            )
            p.text-xs.text-gray-500.mt-1 API requests per minute

        .mt-6.flex.justify-end
          button.px-6.py-2.bg-blue-600.text-white.rounded-lg.transition-colors(
            type="submit"
            class="hover:bg-blue-700"
          ) Save Rate Limits

  //- Alpine.js Config Manager
  script.
    function configManager() {
      return {
        featureFlags: {
          ENABLE_VECTOR_SEARCH: #{featureFlags.ENABLE_VECTOR_SEARCH || false},
          ENABLE_SEMANTIC_TEMPLATES: #{featureFlags.ENABLE_SEMANTIC_TEMPLATES || false},
          ENABLE_SEMANTIC_TOOLS: #{featureFlags.ENABLE_SEMANTIC_TOOLS || false}
        },
        personality: {
          communication: '#{config.communication || "professional"}',
          responseLength: '#{config.responseLength || "balanced"}',
          proactiveness: '#{config.proactiveness || "suggestive"}',
          humor: #{config.humor || 5}
        },
        rateLimits: {
          general: #{rateLimits.general || 100},
          auth: #{rateLimits.auth || 10},
          webhook: #{rateLimits.webhook || 100},
          api: #{rateLimits.api || 60}
        },

        async saveFeatureFlag(key, value) {
          try {
            const response = await fetch('/dashboard/config/update', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.csrfToken
              },
              body: JSON.stringify({
                section: 'feature-flags',
                updates: { [key]: value }
              })
            });

            if (response.ok) {
              console.log(`Feature flag ${key} updated`);
            } else {
              console.error('Failed to update feature flag');
            }
          } catch (error) {
            console.error('Error updating feature flag:', error);
          }
        },

        async savePersonality() {
          try {
            const response = await fetch('/dashboard/config/update', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.csrfToken
              },
              body: JSON.stringify({
                section: 'config',
                updates: this.personality
              })
            });

            if (response.ok) {
              window.location.reload();
            } else {
              console.error('Failed to update personality');
            }
          } catch (error) {
            console.error('Error updating personality:', error);
          }
        },

        async saveRateLimits() {
          try {
            const response = await fetch('/dashboard/config/update', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.csrfToken
              },
              body: JSON.stringify({
                section: 'rate-limits',
                updates: this.rateLimits
              })
            });

            if (response.ok) {
              window.location.reload();
            } else {
              console.error('Failed to update rate limits');
            }
          } catch (error) {
            console.error('Error updating rate limits:', error);
          }
        }
      }
    }
