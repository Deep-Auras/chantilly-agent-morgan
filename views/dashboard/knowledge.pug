extends ../layouts/dashboard

block content
  //- CRITICAL: Single Alpine.js component wrapping entire page to share state
  div(
    x-data="kbController()"
    x-init="init()"
  )
    .mb-6.flex.items-center.justify-between
      div
        h2.text-xl.font-semibold Knowledge Base Management
        p.text-gray-600.text-sm Manage knowledge base documents

      button.px-4.py-2.bg-blue-600.text-white.rounded(
        @click="showAddModal = true"
        class="hover:bg-blue-700"
      ) + Add Entry

    //- Search and Filter
    .bg-white.rounded-lg.shadow.p-4.mb-6
      .grid.grid-cols-1.gap-4(class="md:grid-cols-3")
        div
          label.block.text-sm.font-medium.text-gray-700.mb-2 Search
          input.w-full.px-3.py-2.border.border-gray-300.rounded-md(
            type="text"
            x-model="searchQuery"
            @input="search()"
            placeholder="Search title, content, tags..."
          )

        div
          label.block.text-sm.font-medium.text-gray-700.mb-2 Category
          select.w-full.px-3.py-2.border.border-gray-300.rounded-md(
            x-model="filterCategory"
            @change="filter()"
          )
            option(value="") All Categories
            each category in categories
              option(value=category)= category

        div
          label.block.text-sm.font-medium.text-gray-700.mb-2 Status
          select.w-full.px-3.py-2.border.border-gray-300.rounded-md(
            x-model="filterEnabled"
            @change="filter()"
          )
            option(value="all") All
            option(value="enabled") Enabled Only
            option(value="disabled") Disabled Only

      //- Results Count
      .mt-4.text-sm.text-gray-600
        span(x-text="`Showing ${filteredEntries.length} of ${entries.length} entries`")

    //- Knowledge Base Table
    .bg-white.rounded-lg.shadow.overflow-hidden
      table.min-w-full.divide-y.divide-gray-200
        thead.bg-gray-50
          tr
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | Title
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | Category
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | Priority
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | Status
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | Actions

        tbody.bg-white.divide-y.divide-gray-200
          template(x-for="entry in filteredEntries" :key="entry.id")
            tr
              td.px-6.py-4.whitespace-nowrap
                .font-medium.text-gray-900(x-text="entry.title")
                .text-sm.text-gray-500(
                  x-text="entry.tags.slice(0, 3).join(', ')"
                  x-show="entry.tags.length > 0"
                )

              td.px-6.py-4.whitespace-nowrap
                span.px-2.py-1.text-xs.rounded.bg-gray-100.text-gray-800(
                  x-text="entry.category"
                )

              td.px-6.py-4.whitespace-nowrap
                span.text-sm.text-gray-900(x-text="entry.priority")

              td.px-6.py-4.whitespace-nowrap
                span.px-2.py-1.text-xs.rounded(
                  :class="entry.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                  x-text="entry.enabled ? 'Enabled' : 'Disabled'"
                )

              td.px-6.py-4.whitespace-nowrap.text-sm.font-medium
                button.text-blue-600.mr-4(
                  @click="editEntry(entry)"
                  class="hover:text-blue-900"
                ) Edit
                button.text-red-600(
                  @click="deleteEntry(entry.id)"
                  class="hover:text-red-900"
                ) Delete

    //- Alpine.js KB Controller
    script.
      function kbController() {
        return {
          entries: !{JSON.stringify(entries || [])},
          filteredEntries: [],
          searchQuery: '',
          filterCategory: '',
          filterEnabled: 'all',

          init() {
            this.filteredEntries = this.entries;
          },

          search() {
            this.filter();
          },

          filter() {
            this.filteredEntries = this.entries.filter(entry => {
              // Search filter
              if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                const titleMatch = entry.title.toLowerCase().includes(query);
                const contentMatch = entry.content.toLowerCase().includes(query);
                const tagsMatch = entry.tags.some(tag => tag.toLowerCase().includes(query));

                if (!titleMatch && !contentMatch && !tagsMatch) {
                  return false;
                }
              }

              // Category filter
              if (this.filterCategory && entry.category !== this.filterCategory) {
                return false;
              }

              // Status filter
              if (this.filterEnabled === 'enabled' && !entry.enabled) {
                return false;
              }
              if (this.filterEnabled === 'disabled' && entry.enabled) {
                return false;
              }

              return true;
            });
          },

          async deleteEntry(id) {
            if (!confirm('Are you sure you want to delete this entry?')) {
              return;
            }

            try {
              const response = await fetch(`/dashboard/api/knowledge/${id}`, {
                method: 'DELETE',
                headers: {
                  'X-CSRF-Token': window.csrfToken
                }
              });

              if (response.ok) {
                this.entries = this.entries.filter(e => e.id !== id);
                this.filter();
                alert('Entry deleted successfully!');
              } else {
                const error = await response.json();
                alert(`Error: ${error.message}`);
              }
            } catch (error) {
              alert(`Error: ${error.message}`);
            }
          },

          editEntry(entry) {
            window.location.href = `/dashboard/knowledge/edit/${entry.id}`;
          }
        }
      }
