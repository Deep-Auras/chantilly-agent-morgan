extends ../layouts/dashboard

block content
  div(x-data="activityController()" x-init="loadActivity()")
    .mb-6
      div
        h2.text-xl.font-semibold Activity Logs
        p.text-gray-600.text-sm Security audit trail and system activity monitoring

    //- Filter Options
    .bg-white.rounded-lg.shadow.p-4.mb-6
      .grid.grid-cols-1.gap-4(class="md:grid-cols-4")
        div
          label.block.text-sm.font-medium.text-gray-700.mb-2 Action Type
          select.w-full.px-3.py-2.border.border-gray-300.rounded-md(
            x-model="filterAction"
            @change="filter()"
          )
            option(value="") All Actions
            option(value="config_update") Configuration Updates
            option(value="knowledge_add") Knowledge Added
            option(value="knowledge_update") Knowledge Updated
            option(value="knowledge_delete") Knowledge Deleted
            option(value="tool_toggle") Tool Toggle
            option(value="tool_access_update") Tool Access Changed
            option(value="platform_update") Platform Config
            option(value="user_login") User Login
            option(value="password_change") Password Change

        div
          label.block.text-sm.font-medium.text-gray-700.mb-2 User
          select.w-full.px-3.py-2.border.border-gray-300.rounded-md(
            x-model="filterUser"
            @change="filter()"
          )
            option(value="") All Users
            template(x-for="user in uniqueUsers" :key="user")
              option(:value="user" x-text="user")

        div
          label.block.text-sm.font-medium.text-gray-700.mb-2 Time Range
          select.w-full.px-3.py-2.border.border-gray-300.rounded-md(
            x-model="filterTimeRange"
            @change="filter()"
          )
            option(value="1h") Last Hour
            option(value="24h") Last 24 Hours
            option(value="7d") Last 7 Days
            option(value="30d") Last 30 Days
            option(value="all") All Time

        div.flex.items-end
          button.w-full.px-4.py-2.bg-gray-600.text-white.rounded(
            @click="clearFilters()"
            class="hover:bg-gray-700"
          ) Clear Filters

      //- Results Count
      .mt-4.text-sm.text-gray-600
        span(x-text="`Showing ${filteredLogs.length} of ${logs.length} events`")

    //- Activity Table
    .bg-white.rounded-lg.shadow.overflow-hidden
      table.min-w-full.divide-y.divide-gray-200
        thead.bg-gray-50
          tr
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | Timestamp
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | Action
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | User
            th.px-6.py-3.text-left.text-xs.font-medium.text-gray-500.uppercase.tracking-wider
              | Details

        tbody.bg-white.divide-y.divide-gray-200
          template(x-if="filteredLogs.length === 0")
            tr
              td.px-6.py-8.text-center.text-gray-500(colspan="4") No activity logs found

          template(x-for="log in filteredLogs" :key="log.id")
            tr
              td.px-6.py-4.whitespace-nowrap.text-sm.text-gray-900
                span(x-text="formatTimestamp(log.timestamp)")

              td.px-6.py-4.whitespace-nowrap
                span.px-2.py-1.text-xs.rounded(
                  :class="getActionBadgeClass(log.action)"
                  x-text="formatAction(log.action)"
                )

              td.px-6.py-4.whitespace-nowrap.text-sm.text-gray-900
                span(x-text="log.username || 'System'")

              td.px-6.py-4.text-sm.text-gray-600
                span(x-text="formatDetails(log)")

  //- Alpine.js Controller
  script.
    function activityController() {
      return {
        logs: [],
        filteredLogs: [],
        filterAction: '',
        filterUser: '',
        filterTimeRange: '24h',
        uniqueUsers: [],

        async loadActivity() {
          try {
            const response = await fetch('/api/dashboard/activity?limit=100', {
              headers: {
                'X-CSRF-Token': window.csrfToken
              }
            });

            if (response.ok) {
              const data = await response.json();
              this.logs = data.activities || [];

              // Extract unique users for filter
              this.uniqueUsers = [...new Set(this.logs.map(l => l.username).filter(u => u))];

              this.filter();
            }
          } catch (error) {
            console.error('Failed to load activity logs:', error);
          }
        },

        filter() {
          this.filteredLogs = this.logs.filter(log => {
            // Action filter
            if (this.filterAction && log.action !== this.filterAction) {
              return false;
            }

            // User filter
            if (this.filterUser && log.username !== this.filterUser) {
              return false;
            }

            // Time range filter
            if (this.filterTimeRange !== 'all' && log.timestamp) {
              const logTime = log.timestamp.seconds ? log.timestamp.seconds * 1000 : new Date(log.timestamp).getTime();
              const now = Date.now();
              const ranges = {
                '1h': 60 * 60 * 1000,
                '24h': 24 * 60 * 60 * 1000,
                '7d': 7 * 24 * 60 * 60 * 1000,
                '30d': 30 * 24 * 60 * 60 * 1000
              };

              if (now - logTime > ranges[this.filterTimeRange]) {
                return false;
              }
            }

            return true;
          });
        },

        clearFilters() {
          this.filterAction = '';
          this.filterUser = '';
          this.filterTimeRange = 'all';
          this.filter();
        },

        formatTimestamp(timestamp) {
          if (!timestamp) return 'Unknown';

          let date;
          if (timestamp.seconds) {
            date = new Date(timestamp.seconds * 1000);
          } else {
            date = new Date(timestamp);
          }

          return date.toLocaleString();
        },

        formatAction(action) {
          if (!action) return 'Unknown';
          return action
            .replace(/_/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
        },

        getActionBadgeClass(action) {
          const classes = {
            'config_update': 'bg-blue-100 text-blue-800',
            'knowledge_add': 'bg-green-100 text-green-800',
            'knowledge_update': 'bg-yellow-100 text-yellow-800',
            'knowledge_delete': 'bg-red-100 text-red-800',
            'tool_toggle': 'bg-purple-100 text-purple-800',
            'tool_access_update': 'bg-indigo-100 text-indigo-800',
            'platform_update': 'bg-pink-100 text-pink-800',
            'user_login': 'bg-gray-100 text-gray-800',
            'password_change': 'bg-orange-100 text-orange-800'
          };
          return classes[action] || 'bg-gray-100 text-gray-800';
        },

        formatDetails(log) {
          if (log.entryId) {
            return `Entry: ${log.entryId}`;
          }
          if (log.toolName) {
            return `Tool: ${log.toolName}`;
          }
          if (log.section) {
            return `Section: ${log.section}`;
          }
          if (log.platformId) {
            return `Platform: ${log.platformId}`;
          }
          if (log.details) {
            return JSON.stringify(log.details);
          }
          return '-';
        }
      }
    }
